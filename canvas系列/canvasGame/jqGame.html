<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title></title>
    <style media="screen">
      * {
        margin: 0px;
        padding: 0px;
      }
      #game {
        position: relative;
        z-index: 1;
      }
      .hinder {
        position: absolute;
        z-index: 2;
        left: 0px;
        top: 0px;
      }
      .target {
        position: absolute;
        z-index: 2;
        left: 0px;
        top: 0px;
      }
      .gong {
        position: absolute;
        z-index: 2;
        left: 50%;
        bottom: 0px;
      }
      .arrow {
        position: absolute;
        z-index: 200;
        left: 50%;
        top: 0px;
      }
      p {
        position: absolute;
        z-index: 1000;
        left: 50%;
        top: 50%;
      }
    </style>
  </head>
  <body>
    <div id="game">
    </div>
    <p></p>
  </body>
  <script type="text/javascript" src="./js/requestAnimationFramePolyfill.js"></script>
  <script type="text/javascript" src="./js/jquery.js"></script>
  <script type="text/javascript">
    $(function() {
      var game = $('#game'),
          canvasW = 0,
          canvasH = 0,
          score = 0,
          gongWidth = 0,
          defaultOption = {
            _k: 0.7, //画布高占屏幕比例
            _g: 0.4, //弓箭占屏幕比例
            _a: 201 / 1630 //箭占弓的比例
          },
          isShot = false, //箭完成发射
          hinderOPtion = {
            startY: 0.4, //障碍绘制区域所在相对于画布的位置
            endY: 0.6,
            minWidth: 0.15, //与屏幕宽度比值
            maxWidth: 0.2,
            minSpeedX: 35,
            maxSpeedX: 40
          },
          targetOption = {
            startY: 0,
            endY: 0.4,
            minWidth: 0.1,
            maxWidth: 0.3,
            minTime: 3000,
            maxTime: 5000,
          },
          arrowOption = {
            speedX: 0,
            speedY: 0
          },
          hinderArray = [],
          targetArray = [],
          arrowArray = [],
          i = 0,//设定加载障碍频率
          j = 0 //设定加载目标频率
      function drawGame(defaultOption) {
        canvasW = window.innerWidth
        canvasH = window.innerHeight * defaultOption._k
        game.width(canvasW).height(canvasH)
        $('body').css({
          'background': 'url("./images/bg.png")',
          'overflow': 'hidden'
        })
        var newGong = new Image()
        newGong.src = './images/gong.png'
        newGong.id = 'gong'
        newGong.onload = function() {
          gongWidth = canvasW * defaultOption._g
          $(newGong).css({
            'width': gongWidth,
            'margin-left': -canvasW * defaultOption._g / 2
          }).addClass('gong')
          game.append(newGong)
        }
      }
      function Hinder(id, type, startY, width, speedX) {
        this.id = id || ''
        this.type = type || Math.random() > 0.5 ? 0 : 1 //从左侧还是右侧进入；0左侧，1右侧
        this.x = this.type === 0 ? 0 : canvasW
        this.y = startY || random(hinderOPtion.startY * canvasH, hinderOPtion.endY * canvasH)
        this.width = width || random(hinderOPtion.minWidth * canvasW, hinderOPtion.maxWidth * canvasW)
        this.speedX = speedX / 10 || random(hinderOPtion.minSpeedX, hinderOPtion.maxSpeedX) / 10
        this.shot = false
        this.draw = function() {
          var img = new Image(),
              _self = this
          img.src = './images/dadiao.gif'
          img.id = _self.id
          img.onload = function() {
            if(_self.type) {
              $(img).css({
                'left': canvasW + _self.width
              })
            } else {
              $(img).css({
                'left': -_self.width,
                'transform':'rotateY(180deg)',
                '-ms-transform':'rotateY(180deg)', 	/* IE 9 */
                '-moz-transform':'rotateY(180deg)', 	/* Firefox */
                '-webkit-transform':'rotateY(180deg)', /* Safari 和 Chrome */
                '-o-transform':'rotateY(180deg)'
              })
            }
            $(img).css({
              'transition-property': 'left',
              '-moz-transition-property': 'left', /* Firefox 4 */
              '-webkit-transition-property': 'left', /* Safari 和 Chrome */
              '-o-transition-property': 'left', /* Opera */
              'transition-timing-function': 'linear',
              '-moz-transition-timing-function': 'linear', /* Firefox 4 */
              '-webkit-transition-timing-function': 'linear', /* Safari 和 Chrome */
              '-o-transition-timing-function': 'linear', /* Opera */
              'transition-duration': _self.speedX + 's',
              '-moz-transition-duration': _self.speedX + 's', /* Firefox 4 */
              '-webkit-transition-duration': _self.speedX + 's', /* Safari 和 Chrome */
              '-o-transition-duration': _self.speedX + 's', /* Opera */
              'width':_self.width,
              'top': _self.y,
            }).addClass('hinder')
            game.append(img)
            setTimeout(function() {
              if(_self.type) {
                $(img).css({
                  'left': - _self.width,
                })
              } else {
                $(img).css({
                  'left': canvasW,
                })
              }
              _self.shot = true
            }, 100)
          }
        }
        this.angle = function() {
          var left = parseInt($('#' + this.id).css('left'))
          if(left > canvasW) left = canvasW
          if(left < 0) left = 0
          var anglemax = Math.atan2( canvasH - this.y, left - canvasW / 2)
          var anglemin = Math.atan2( canvasH - this.y ,left + this.width - canvasW / 2 )
          function angleCal(angle) {
            return (angle / Math.PI * 180) < 0 ? angle / Math.PI * 180 - 90 : angle / Math.PI * 180
          }
          var angleMax = angleCal(anglemax)
          var angleMmin = angleCal(anglemin)
          return {
            max: angleMax,
            min: angleMmin
          }
        }
      }
      function Target(id, nowTime, width, x, y, time) {
        this.id = id
        this.width = width || random(targetOption.minWidth * canvasW, targetOption.maxWidth * canvasW)
        this.x = x || random(0, canvasW - this.width)
        this.y = y || random(targetOption.startY * canvasH, targetOption.endY * canvasH - this.width)
        this.time = time || random(targetOption.minTime, targetOption.maxTime)
        this.now = nowTime
        this.draw = function(item) {
          var img = new Image(),
              _self = this
          img.src = './images/sun.png'
          img.id = _self.id
          img.onload = function() {
            if(item) {
              var isOk = true
              targetArray.forEach(function(obj, index) {
                  var x = obj.x - item.x,
                      y = obj.y - item.y,
                      dis = Math.sqrt(x*x + y*y)
                  if(dis < item.width / 2 + obj.width / 2 + 30) {
                    isOk = false
                  }
              })
              if(isOk) {
                targetArray.push(item)
                $(img).addClass('target').css({
                  left: _self.x,
                  top: _self.y,
                  width: _self.width
                })
                game.append(img)
              }
            }
          }
        }
        this.clear = function() {
            $('#' + this.id).remove()
        }
      }
      function Arrow(id, tX, tY, speed, x, y){
        this.id = id || ''
        this.tX = tX || 0
        this.tY = tY || 0
        this.speed = speed || 5
        this.sX = canvasW / 2
        this.sY = canvasH
        this.x = x || canvasW / 2
        this.y = y || canvasH
        // this.x = 0
        // this.y = 0
        var _k = (Math.abs(this.tY - this.sY)) / (Math.abs(this.tX - this.sX)),
            speedX = this.speed / (Math.sqrt(_k * _k) + 1),
            speedY = _k * speedX,
            disX = this.tX > this.x
            rotateAngle = Math.atan2(this.tX - this.sX, -(this.tY - this.sY))
        this.draw = function() {
          var img = new Image(),
              _self = this
          img.src = './images/arrow.jpeg'
          img.onload = function() {
            ctx.save()
            // ctx.translate(_self.sX, _self.sY)
            ctx.rotate(rotateAngle)
            ctx.clearRect(_self.x, _self.y, img.width, img.height)
            _self.x = disX > 0 ? _self.x + speedX : _self.x -speedX
            _self.y = _self.y - speedY
            ctx.drawImage(img, _self.x, _self.y, img.width, img.height)
            ctx.restore()
            if(_self.y < 0 - img.height || _self.x < 0 - img.width || _self.x >  canvasW + img.width) {
              arrowArray = arrowArray.filter(function(item, index) {
                return item.id !== _self.id
              })
              isShot = false
            }
          }
        }
      }
      function random(min,max) {
          return parseInt(Math.random()*(max - min) + min);
      }
      function eventLoopHinder() {
        var id = Math.random().toString().split('.')[1]
        var newHinder = new Hinder(id)
        newHinder.draw()
        hinderArray.push(newHinder)
        setTimeout(eventLoopHinder, 1000)
      }
      function clearHinder() {
        hinderArray.forEach(function(item, index) {
          if(item.shot) {
            if($('#' + item.id).css('left') == canvasW + 'px' || $('#' + item.id).css('left') == -item.width + 'px') {
              $('#' + item.id).remove()
              hinderArray.splice(index, 1)
            }
          }
        })
        setTimeout(clearHinder, 1000)
      }
      function eventLoopTarget() {
        j++
        if(j % 3 === 0) {
          var id = Math.random().toString().split('.')[1]
          var nowTime = new Date().getTime()
          var newTarget = new Target(id, nowTime)
          targetArray = targetArray.filter(function(item, index) {
            if(item.time + item.now < nowTime) item.clear()
            return item.time + item.now > nowTime
          })
          newTarget.draw(newTarget)
        }
        setTimeout(eventLoopTarget, 300)
      }
      function touchEvent() {
          var x, y, time
          game.on('touchstart',function(e) {
              var _touch = e.originalEvent.targetTouches[0]
              time = new Date().getTime()
              x = _touch.clientX
              y = _touch.clientY
          })
          game.on('touchend',function(e) {
            $('#arrow').remove()
              if(new Date().getTime() - time < 200) {
                var touchAngle = Math.atan2(canvasH - y, x - canvasW / 2) / Math.PI * 180,
                    isFail = false,
                    gongAngle = 90 - touchAngle,
                    rotateObj = {
                                  'transform':'rotateZ('+ gongAngle +'deg)',
                                  '-ms-transform':'rotateZ('+ gongAngle +'deg)',  /* IE 9 */
                                  '-moz-transform':'rotateZ('+ gongAngle +'deg)',   /* Firefox */
                                  '-webkit-transform':'rotateZ('+ gongAngle +'deg)', /* Safari 和 Chrome */
                                  '-o-transform':'rotateZ('+ gongAngle +'deg)'
                                }
                $('#gong').css(rotateObj)
                var newArrow = new Image()
                newArrow.src = './images/arrow.png'
                newArrow.id = 'arrow'
                newArrow.onload = function() {
                  var speed = 0.1,
                      scale = newArrow.height / newArrow.width,
                      width = gongWidth * defaultOption._a
                  $(newArrow).css({
                    'width': width,
                    'top': canvasH - width * scale,
                    'margin-left': -gongWidth * defaultOption._a / 2,
                    'transition-property': 'all',
                    '-moz-transition-property': 'all', /* Firefox 4 */
                    '-webkit-transition-property': 'all', /* Safari 和 Chrome */
                    '-o-transition-property': 'all', /* Opera */
                    'transition-timing-function': 'linear',
                    '-moz-transition-timing-function': 'linear', /* Firefox 4 */
                    '-webkit-transition-timing-function': 'linear', /* Safari 和 Chrome */
                    '-o-transition-timing-function': 'linear', /* Opera */
                    'transition-duration': speed + 's',
                    '-moz-transition-duration': speed + 's', /* Firefox 4 */
                    '-webkit-transition-duration': speed + 's', /* Safari 和 Chrome */
                    '-o-transition-duration': speed + 's', /* Opera */
                  }).css(rotateObj).addClass('arrow')
                  game.append(newArrow)
                  hinderArray.forEach(function(item, index) {
                    var angleObj = item.angle()
                    var left = parseInt($('#' + item.id).css('left'))
                    if(touchAngle > angleObj.min && touchAngle < angleObj.max) {
                      var bottom = canvasH - item.y - $(newArrow).width() * scale / 2
                      var arrowLeft = bottom / (canvasH - y) * (x - canvasW / 2) //根据tan值算出具体left
                      $('#arrow').css({
                        left: arrowLeft + canvasW / 2,
                        top: canvasH - bottom - newArrow.height / 2,
                        margin: 0
                      })
                      var newImg = new Image()
                      newImg.src = './images/dadiao-shot.png'
                      newImg.onload = function() {
                        $(newImg).addClass('hinder').css({
                          left: left,
                          top: item.y,
                          width: item.width,
                        })
                        if(!item.type) {
                          $(newImg).css({
                            'transform':'rotateY(180deg)',
                            '-ms-transform':'rotateY(180deg)',  /* IE 9 */
                            '-moz-transform':'rotateY(180deg)',   /* Firefox */
                            '-webkit-transform':'rotateY(180deg)', /* Safari 和 Chrome */
                            '-o-transform':'rotateY(180deg)'
                          })
                        }   
                        game.append(newImg)
                        $('#' + item.id).remove()
                        $(newImg).fadeOut('normal', function(){
                          $(this).remove()
                        })
                        $('#arrow').fadeOut()
                        
                      }
                      hinderArray.splice(index, 1)
                      isFail = true
                    }
                  })
                  if(!isFail) {
                    targetArray.forEach(function(item, index) {
                      var disX = item.x - x
                      var disY = item.y - y
                      var dis = Math.sqrt(disX * disX + disY * disY)
                      if(dis < item.width) {
                        var bottom = canvasH - item.y - $(newArrow).width() * scale / 2
                        var arrowLeft = bottom / (canvasH - y) * (x - canvasW / 2) //根据tan值算出具体left
                        $('#arrow').css({
                          left: arrowLeft + canvasW / 2,
                          top: canvasH - bottom - newArrow.height / 2,
                          margin: 0
                        })
                        $('#' + item.id).attr('src', './images/sun-shot.png').fadeOut(1000, function() {
                          $(this).remove()
                        })
                        $('#arrow').fadeOut()
                        targetArray.splice(index, 1)
                      }
                    })
                  }
                }
                
              }
          })
      }
      function init() {
        drawGame(defaultOption)
        eventLoopHinder()
        clearHinder()
        eventLoopTarget()
        touchEvent()
      }
      init()
    })
  </script>
</html>
